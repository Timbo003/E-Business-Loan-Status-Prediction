---
title: "E-Business Loan Status Prediction"
output: 
  html_document:
    keep_md: true
---

# Load libraries

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(caret)
library(randomForest)
```

------------------------------------------------------------------------

# Load the data

```{r}
rawData <- read_csv("loan_data.csv")

# print col names
names(rawData)
```

# Transform the data

```{r}
rawData <- read_csv("loan_data.csv")

# Drop the Loan_ID column
rawData <- rawData %>% select(-Loan_ID)

# Transform categorical variables to factors
rawData <- rawData %>% mutate(
  Married = factor(ifelse(Married == "Yes", TRUE, FALSE)),
  Education = factor(ifelse(Education == "Graduate", TRUE, FALSE)),
  Self_Employed = factor(ifelse(Self_Employed == "Yes", TRUE, FALSE)),
  Gender = factor(Gender),
  Dependents = factor(Dependents),
  Property_Area = factor(Property_Area),
  Loan_Status = factor(Loan_Status)
)

print(rawData)
```
```{r}
# drop all missing values just for testing TODO
rawData <- na.omit(rawData)
```



```{r}
# Check for null values and handle them (if any)
null_counts <- colSums(is.na(rawData))
print(null_counts)
```

------------------------------------------------------------------------

# Initial Data sighting

```{r}
# Plot 1: Distribution of Loan Status with customized colors
ggplot(rawData, aes(x = Loan_Status, fill = Loan_Status)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = c("Y" = "#90EE90", "N" = "#FFB6C1")) +
  theme_minimal() +
  ggtitle("Distribution of Loan Status")
```

```{r}
# Plot 2: Distribution of Gender with customized RGB colors
ggplot(rawData, aes(x = Gender, fill = Gender)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = c("Male" = "#89CFF0", "Female" = "#FFB6C1")) +
  theme_minimal() +
  ggtitle("Distribution of Gender")
```

```{r}
# Plot 3: Average Loan Amount by Property Area
avg_loan_amount <- rawData %>%
  group_by(Property_Area) %>%
  summarise(Average_LoanAmount = mean(LoanAmount, na.rm = TRUE))

ggplot(avg_loan_amount, aes(x = Property_Area, y = Average_LoanAmount, fill = Property_Area)) +
  geom_bar(stat = "identity", color = "black") +
  theme_minimal() +
  ggtitle("Average Loan Amount by Property Area") +
  labs(y = "Average Loan Amount", fill = "Property Area")
```

```{r}
# Plot 4: Distribution of Loan Status by Education
ggplot(rawData, aes(x = Loan_Status, fill = Education)) +
  geom_bar(position = "dodge", color = "black") +
  theme_minimal() +
  ggtitle("Distribution of Loan Status by Education") +
  labs(fill = "Education")
```

```{r}
# Plot 5: Distribution of Loan Status by Self Employed status
ggplot(rawData, aes(x = Loan_Status, fill = Self_Employed)) +
  geom_bar(position = "dodge", color = "black") +
  theme_minimal() +
  ggtitle("Distribution of Loan Status by Self Employed Status") +
  labs(fill = "Self Employed")
```


# Split Data into Training and Testing Sets
```{r}
set.seed(123)  # For reproducibility

# Split the data into training (80%) and testing (20%) sets
trainIndex <- createDataPartition(rawData$Loan_Status, p = .8, 
                                  list = FALSE, 
                                  times = 1)
trainData <- rawData[ trainIndex,]
testData  <- rawData[-trainIndex,]
```

# Train the Random Forest Model
```{r}
# Train the model
rf_model <- randomForest(Loan_Status ~ ., data = trainData, importance = TRUE, ntree = 500)

# Print the model
print(rf_model)

# Check the importance of variables
importance(rf_model)
```

# Evaluate the Model
```{r}
# Predict on the test data
predictions <- predict(rf_model, newdata = testData)

# Confusion matrix
confusionMatrix(predictions, testData$Loan_Status)

# Plot ROC curve and calculate AUC
library(pROC)
roc_obj <- roc(testData$Loan_Status, as.numeric(predictions))
auc(roc_obj)
plot(roc_obj, main="ROC Curve for Random Forest Model")
```

# Visualize Important Variables
```{r}
# Plot the importance of variables
varImpPlot(rf_model, main="Variable Importance in Random Forest Model")
```
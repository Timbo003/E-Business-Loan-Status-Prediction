---
title: "E-Business Loan Status Prediction"
output: 
  html_document:
    keep_md: true
---

# Load libraries

```{r}
library(tidyverse)
library(caret)
library(randomForest)
library(e1071)
library(pROC)
library(rpart)
```

# Load & Transform the data

```{r}
# Load the data
rawData <- read.csv("loan_data.csv")

# Transform the data
rawData <- rawData %>%
  select(-Loan_ID) %>%
  mutate(Married = Married == "Yes",
         Education = Education == "Graduate",
         Self_Employed = Self_Employed == "Yes",
         Gender = as.factor(Gender),
         Dependents = as.factor(Dependents),
         Property_Area = as.factor(Property_Area),
         Loan_Status = as.factor(Loan_Status == "Y"))
```

# Feature Engineering

```{r}
rawData <- rawData %>%
  mutate(Total_Income = ApplicantIncome + CoapplicantIncome,
         Income_to_Loan = Total_Income / LoanAmount)

# Drop all missing values just for testing TODO
rawData <- drop_na(rawData)

# Check for null values and handle them (if any)
null_counts <- colSums(is.na(rawData))
print(null_counts)
```

```{r}
# Save the data as a csv #TODO
write.csv(rawData, "C:/Users/timst/Documents/GitHub/E-Business-Loan-Status-Prediction/rawData.csv")
```

# Initial Data sighting

```{r}
# Plot 1: Distribution of Loan Status with customized colors
ggplot(rawData, aes(x = Loan_Status, fill = Loan_Status)) +
  geom_bar() +
  scale_fill_manual(values = c("TRUE" = "#90EE90", "FALSE" = "#FFB6C1")) +
  ggtitle("Distribution of Loan Status") +
  theme_minimal()

# Plot 2: Distribution of Gender with customized RGB colors
ggplot(rawData, aes(x = Gender, fill = Gender)) +
  geom_bar() +
  scale_fill_manual(values = c("Male" = "#89CFF0", "Female" = "#FFB6C1")) +
  ggtitle("Distribution of Gender") +
  theme_minimal()

# Plot 3: Distribution of Loan Status by Education
ggplot(rawData, aes(x = Loan_Status, fill = Education)) +
  geom_bar(position = "dodge") +
  ggtitle("Distribution of Loan Status by Education") +
  theme_minimal()

# Plot 4: Distribution of Loan Status by Self Employed status
ggplot(rawData, aes(x = Loan_Status, fill = Self_Employed)) +
  geom_bar(position = "dodge") +
  ggtitle("Distribution of Loan Status by Self Employed Status") +
  theme_minimal()

#Average Loan Amounts Requested and Granted

# Plot 1: Average Loan Amount requested by Gender
# Calculate the average loan amount by gender and remove missing values
avg_loan_amount_gender <- rawData %>%
  filter(!is.na(Gender) & Gender != "") %>%
  group_by(Gender) %>%
  summarize(LoanAmount = mean(LoanAmount, na.rm = TRUE))

# Create the bar plot
ggplot(avg_loan_amount_gender, aes(x = Gender, y = LoanAmount)) +
  geom_bar(stat = "identity") +
  ggtitle("Average Loan Amount requested by Gender") +
  ylab("Average Loan Amount") +
  theme_minimal()

# Plot 2: Average Loan Amount  granted granted by Gender
# Calculate the average loan amount by gender and remove missing values
avg_loan_amount_gender <- rawData %>%
  filter(Loan_Status == "TRUE" & !is.na(Gender) & Gender != "") %>%
  group_by(Gender) %>%
  summarize(LoanAmount = mean(LoanAmount, na.rm = TRUE))

# Create the bar plot
ggplot(avg_loan_amount_gender, aes(x = Gender, y = LoanAmount)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  ggtitle("Average Loan Amount granted by Gender") +
  ylab("Average Loan Amount") +
  theme_minimal()

# Plot 3: Average Loan Amount requested by Property Area
avg_loan_amount <- rawData %>%
  group_by(Property_Area) %>%
  summarize(LoanAmount = mean(LoanAmount))

ggplot(avg_loan_amount, aes(x = Property_Area, y = LoanAmount)) +
  geom_bar(stat = "identity") +
  ggtitle("Average Loan Amount requested by Property Area") +
  ylab("Average Loan Amount") +
  theme_minimal()


# Plot 3: Average Loan Amount requested by Property Area
avg_loan_amount <- rawData %>%
  filter(Loan_Status == "TRUE") %>%
  group_by(Property_Area) %>%
  summarize(LoanAmount = mean(LoanAmount))

ggplot(avg_loan_amount, aes(x = Property_Area, y = LoanAmount)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  ggtitle("Average Loan Amount granted by Property Area") +
  ylab("Average Loan Amount") +
  theme_minimal()

```


```{r}
# Model Training
# Split Data into Training and Testing Sets
set.seed(123)
trainIndex <- createDataPartition(rawData$Loan_Status, p = .8, 
                                  list = FALSE, 
                                  times = 1)
X_train <- rawData[trainIndex,]
X_test <- rawData[-trainIndex,]
```

```{r}
# Ensure Loan_Status is a factor
X_train$Loan_Status <- as.factor(X_train$Loan_Status)
X_test$Loan_Status <- as.factor(X_test$Loan_Status)
```

```{r}
# Preprocessing
preprocess <- preProcess(X_train, method = c("center", "scale"))
X_train <- predict(preprocess, X_train)
X_test <- predict(preprocess, X_test)
```

### Train and Evaluate the Random Forest Model

```{r}
rf_grid <- expand.grid(mtry = c(2, 4, 6))
rf_control <- trainControl(method = "cv", number = 10)
rf_model <- train(Loan_Status ~ ., data = X_train, method = "rf", 
                  trControl = rf_control, tuneGrid = rf_grid)

rf_predictions <- predict(rf_model, X_test)
confusionMatrix(rf_predictions, X_test$Loan_Status)

rf_probs <- predict(rf_model, X_test, type = "prob")[, 2]
rf_roc <- roc(X_test$Loan_Status, rf_probs)
plot(rf_roc, main = "ROC Curve for Random Forest Model")

rf_metrics <- data.frame(Accuracy = max(rf_model$results$Accuracy), 
                         AUC = auc(rf_roc))
```

### Train and Evaluate the KNN Model

```{r}
knn_model <- train(Loan_Status ~ ., data = X_train, method = "knn", tuneLength = 5)
knn_predictions <- predict(knn_model, X_test)
confusionMatrix(knn_predictions, X_test$Loan_Status)

knn_probs <- predict(knn_model, X_test, type = "prob")[, 2]
knn_roc <- roc(X_test$Loan_Status, knn_probs)
plot(knn_roc, main = "ROC Curve for KNN Model")

knn_metrics <- data.frame(Accuracy = max(knn_model$results$Accuracy), 
                          AUC = auc(knn_roc))
```

### Train and Evaluate the Decision Tree Model

```{r}
dt_model <- train(Loan_Status ~ ., data = X_train, method = "rpart")
dt_predictions <- predict(dt_model, X_test)
confusionMatrix(dt_predictions, X_test$Loan_Status)

dt_probs <- predict(dt_model, X_test, type = "prob")[, 2]
dt_roc <- roc(X_test$Loan_Status, dt_probs)
plot(dt_roc, main = "ROC Curve for Decision Tree Model")

dt_metrics <- data.frame(Accuracy = max(dt_model$results$Accuracy), 
                         AUC = auc(dt_roc))
```

# Compare Models

```{r}
model_comparison <- data.frame(
  Model = c("Random Forest", "KNN", "Decision Tree"),
  Accuracy = c(rf_metrics$Accuracy, knn_metrics$Accuracy, dt_metrics$Accuracy),
  AUC = c(rf_metrics$AUC, knn_metrics$AUC, dt_metrics$AUC)
)

print(model_comparison)
```

# Identify the best model

```{r}
best_model_name <- model_comparison[which.max(model_comparison$AUC), "Model"]
print(paste("Best model based on AUC is:", best_model_name))

if (best_model_name == "Random Forest") {
  best_model <- rf_model$finalModel
  varImpPlot(best_model)
} else if (best_model_name == "Decision Tree") {
  best_model <- dt_model$finalModel
  rpart.plot(best_model)
}
```
